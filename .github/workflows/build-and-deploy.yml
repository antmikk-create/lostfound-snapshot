name: Build and Deploy Snapshot

on:
  schedule:
    - cron: "0 * * * *"  # Tunnin välein (esim. 01:00, 02:00...)
  
  # Manuaalinen käynnistys
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild all pages"
        required: false
        default: "false"
        type: boolean
  
  # Build kun koodi päivittyy
  push:
    branches: [ main, master ]
  
  # Build kun secrets päivittyvät
  repository_dispatch:
    types: [ new-data-available ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: \${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create Firebase credentials
        run: |
          echo '\${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > firebase-service-account.json
          echo "Firebase credentials file created (\$(wc -c < firebase-service-account.json) bytes)"
      
      - name: Build snapshot
        run: npm run build
        env:
          SUPABASE_URL: \${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: \${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          BUILD_TIMESTAMP: \${{ github.run_number }}
          GITHUB_SHA: \${{ github.sha }}
          GITHUB_USERNAME: \${{ github.repository_owner }}
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dist"
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Show deployment info
        run: |
          echo "✅ Build completed successfully!"
          echo "📊 Build number: \${{ github.run_number }}"
          echo "🔗 Pages URL: \${{ steps.deployment.outputs.page_url }}"
          echo "📅 Timestamp: \$(date -Iseconds)"
      
      - name: Create summary
        if: always()
        run: |
          echo "## 🚀 Deployment Summary" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY
          echo "- **Status:** \${{ job.status }}" >> \$GITHUB_STEP_SUMMARY
          echo "- **Build:** #\${{ github.run_number }}" >> \$GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`\${{ github.sha }}\`" >> \$GITHUB_STEP_SUMMARY
          echo "- **URL:** [\${{ steps.deployment.outputs.page_url }}](\${{ steps.deployment.outputs.page_url }})" >> \$GITHUB_STEP_SUMMARY
          echo "- **Time:** \$(date)" >> \$GITHUB_STEP_SUMMARY
